"use strict";var t=require("@agconnect/api"),e=require("@agconnect/core");require("@agconnect/baseservice");var r=require("bignumber.js"),n=require("@agconnect/log");function o(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}require("@agconnect/instance"),require("@agconnect/network");var i=o(t),s=o(r),c=function(t,e){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,e)};function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}c(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function u(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function c(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,c)}a((n=n.apply(t,e||[])).next())}))}function p(t,e){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}var h=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=""),this.code=t,this.msg=e}return t.prototype.getCode=function(){return this.code},t.prototype.setCode=function(t){this.code=t},t.prototype.getMsg=function(){return this.msg},t.prototype.setMsg=function(t){this.msg=t},t}(),d=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.responseBody=void 0,e}return a(e,t),e.prototype.constructResponse=function(t){this.responseBody=t},e.prototype.getValue=function(){return this.responseBody?this.responseBody:null},e}(function(){function t(){this.ret=new h}return t.prototype.isSuccess=function(){return null!=this.ret&&0==this.ret.getCode()},t.prototype.getRet=function(){return this.ret},t.prototype.setRet=function(t){this.ret=t},t.prototype.constructResponse=function(t){},t}()),g=function(){function t(t,e){this.code=e,this.errMsg=t}return t.CLIENT_TOKEN_EXPIRED=205524993,t.ACCESS_TOKEN_EXPIRED=205524994,t}(),f=function(){function t(){}return t.prototype.doRequest=function(e,r,n,o){return u(this,void 0,void 0,(function(){var s,c,a,h,f,l,y=this;return p(this,(function(k){switch(k.label){case 0:return s=e.getHeader(),(c=i.default.instance().getService("AuthProviderService"))?[4,c.getToken(!1).then((function(t){t&&(s.accessToken=t.getToken())}))]:[3,2];case 1:k.sent(),k.label=2;case 2:return(a=i.default.instance().getService("CredentialsService"))?(h="",[4,a.getToken().then((function(t){h=t.tokenString}))]):(w.error("get credentialProvider service failed."),[2,Promise.reject("get credentialProvider service failed.")]);case 3:return k.sent(),s.Authorization="Bearer "+h,f=void 0,r&&(f={timeout:r,timeoutErrorMessage:"CloudFunction run out of time"}),l=new d,[4,this.doNetworkOption(e,s,l,f).then((function(t){return Promise.resolve(l)})).catch((function(i){return u(y,void 0,void 0,(function(){var s;return p(this,(function(u){switch(u.label){case 0:return i.response&&i.response.status&&i.response.data&&i.response.data.ret&&i.response.data.ret.code?i.response.status!==t.TOKEN_INVALID?[3,6]:(s="0x0"+(s=i.response.data.ret.code).toString(16))==g.CLIENT_TOKEN_EXPIRED&&n?[4,a.removeToken()]:[3,3]:[3,6];case 1:return u.sent(),[4,a.getToken(!0)];case 2:return u.sent(),[2,this.doRequest(e,r,!1,o)];case 3:return s==g.ACCESS_TOKEN_EXPIRED&&o?c?[4,c.getToken(!0)]:[3,5]:[3,6];case 4:u.sent(),u.label=5;case 5:return[2,this.doRequest(e,r,n,!1)];case 6:return i.message&&"Network Error"==i.message&&!e.useBackUrl?(e.useBackUrl=!0,[2,this.doRequest(e,r,n,o)]):[2,Promise.reject(i)]}}))}))}))];case 4:return k.sent(),[2,Promise.resolve(l)]}}))}))},t.prototype.doNetworkOption=function(e,r,n,o){return u(this,void 0,void 0,(function(){var s;return p(this,(function(c){switch(c.label){case 0:return(s=i.default.instance().getService("AGCNetworkService"))?[4,s.post(e.getUrl(),e.getBody(),r,o).then((function(e){return e.status&&e.status===t.HTTP_OK?(n.ret.setCode(0),n.ret.setMsg("OK"),n.constructResponse(e.data),Promise.resolve()):Promise.reject(e)})).catch((function(t){return Promise.reject(t)}))]:(w.error("get agcNetwork service failed."),[2,Promise.reject("get agcNetwork service failed.")]);case 1:return c.sent(),[2]}}))}))},t.TOKEN_INVALID=401,t.HTTP_OK=200,t}(),l=function(){function t(){this.sdkPlatform="",this.sdkPlatformVersion="",this.sdkType="JS",this.packageName="",this.appVersion="",this.headerClientId="",this.headerProductId="",this.headerAppId="",this.agcgwUrl="",this.agcgwBackUrl="",this.sdkServiceName="agconnect-function",this.sdkVersion="1.3.0";var t=i.default.instance().getService("AGCPlatformInfoService");t&&(this.sdkPlatform=t.getPlatform(),this.sdkPlatformVersion=t.getPlatformVersion(),this.packageName=t.getPackageName(),this.appVersion=t.getAppVersion()),this.authorization="";try{this.agcConfig=i.default.instance().config()}catch(t){throw w.error(t),t}this.headerProductId=this.agcConfig.client.product_id,this.headerClientId=this.agcConfig.client.client_id,this.headerAppId=this.agcConfig.client.app_id,this.agcgwUrl=this.addHttpToUrl(this.agcConfig.agcgw.url),this.agcgwBackUrl=this.addHttpToUrl(this.agcConfig.agcgw.backurl)}return t.prototype.getSdkServiceName=function(){return this.sdkServiceName},t.prototype.getSdkVersion=function(){return this.sdkVersion},t.prototype.getSdkPlatformVersion=function(){return this.sdkPlatformVersion},t.prototype.setSdkPlatformVersion=function(t){this.sdkPlatformVersion=t},t.prototype.getSdkType=function(){return this.sdkType},t.prototype.getPackageName=function(){return this.packageName},t.prototype.setPackageName=function(t){this.packageName=t},t.prototype.getAppVersion=function(){return this.appVersion},t.prototype.setAppVersion=function(t){this.appVersion=t},t.prototype.setSdkVersion=function(t){this.sdkVersion=t},t.prototype.getSdkPlatform=function(){return this.sdkPlatform},t.prototype.setSdkPlatform=function(t){this.sdkPlatform=t},t.prototype.getHeaderProductId=function(){return this.headerProductId},t.prototype.setHeaderProductId=function(t){this.headerProductId=t},t.prototype.getHeaderAppId=function(){return this.headerAppId},t.prototype.setHeaderAppId=function(t){this.headerAppId=t},t.prototype.getHeaderClientId=function(){return this.headerClientId},t.prototype.setHeaderClientId=function(t){this.headerClientId=t},t.prototype.getAuthorization=function(){return this.authorization},t.prototype.setAuthorization=function(t){this.authorization=t},t.prototype.getAgcgwUrl=function(){return this.agcgwUrl},t.prototype.setAgcgwUrl=function(t){this.agcgwUrl=t},t.prototype.getAgcgwBackUrl=function(){return this.agcgwBackUrl},t.prototype.setAgcgwBackUrl=function(t){this.agcgwBackUrl=t},t.prototype.addHttpToUrl=function(t){return t&&!t.startsWith("https://")?"https://"+t:t},t}(),y="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",k=function(){function t(){}return t.hash=function(e,r){var n="agc:"+e+"@"+r,o=t.MD5Hash(n);o="0x"+o;var i=new s.default(o);return t.encode(i)},t.encode=function(t){for(var e="";t.isGreaterThan(61);){var r=t.modulo(62);e=y.charAt(r.toNumber())+e,t=t.dividedToIntegerBy(62)}return e=y.charAt(t.toNumber())+e},t.MD5Hash=require("js-md5"),t}(),v=function(t){function e(e,r){var n=t.call(this)||this;return n.useBackUrl=!1,n.body=r,n.httpTriggerURI=e,n}return a(e,t),e.prototype.getUrl=function(){var t=this.agcConfig.client.cp_id,r=this.agcConfig.client.product_id,n=k.hash(t,r);return this.httpTriggerURI&&this.httpTriggerURI.length>0&&"/"!=this.httpTriggerURI.charAt(0)&&(this.httpTriggerURI="/"+this.httpTriggerURI),this.useBackUrl?this.getAgcgwBackUrl()+e.SERVER_URL+"/"+n+this.httpTriggerURI:this.getAgcgwUrl()+e.SERVER_URL+"/"+n+this.httpTriggerURI},e.prototype.getHeader=function(){return{sdkVersion:this.getSdkVersion(),sdkPlatform:this.getSdkPlatform(),sdkServiceName:this.getSdkServiceName(),sdkPlatformVersion:this.getSdkPlatformVersion(),sdkType:this.getSdkType(),packageName:this.getPackageName(),appVersion:this.getAppVersion(),appId:this.getHeaderAppId(),clientId:this.getHeaderClientId(),productId:this.getHeaderProductId(),Authorization:this.getAuthorization(),"Content-Type":"application/json;charset=UTF-8"}},e.prototype.getBody=function(){return this.body},e.SERVER_URL="/agc/apigw/wisefunction/functions",e}(l),m=function(){function t(t){this.httpTriggerURI="",this.timeout=void 0,this.functionBackend=new f,this.httpTriggerURI=t}return t.prototype.call=function(t){return u(this,void 0,void 0,(function(){var e;return p(this,(function(r){return e=new v(this.httpTriggerURI,t),[2,this.functionBackend.doRequest(e,this.timeout,!0,!0)]}))}))},t.prototype.clone=function(e){var r=new t(this.httpTriggerURI);return r.timeout=e,r},t}(),w=n.Logger.createLogger("function"),P=function(){function t(){}return t.prototype.wrap=function(t){return new m(t)},t}(),I=new e.Singleton((function(){return new P}));i.default.registerApiProvider("function",(function(){return I.get()}));
