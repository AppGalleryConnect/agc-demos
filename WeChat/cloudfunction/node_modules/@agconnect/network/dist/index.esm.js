import e from"@agconnect/api";import t from"axios";import"@agconnect/instance";import{Logger as o}from"@agconnect/log";var r=function(){function e(e){this.CancelToken=t.CancelToken,t.defaults.timeout=3e3,null==e&&null==e||(t.defaults.adapter=e)}return e.prototype.getAxiosIns=function(){return t},e.prototype.post=function(e,t,o,r){return this.sendRequest("POST",e,t,o,r)},e.prototype.get=function(e,t,o,r){return this.sendRequest("GET",e,t,o,r)},e.prototype.delete=function(e,t,o,r){return this.sendRequest("DELETE",e,t,o,r)},e.prototype.put=function(e,t,o,r){return this.sendRequest("PUT",e,t,o,r)},e.prototype.sendRequest=function(e,o,r,n,s){if(!this.checkParam(o))return Promise.reject("URL IS ERROR!");var c={url:o,method:e,transformResponse:null==s?void 0:s.transformResponse,headers:n,timeout:null==s?void 0:s.timeout,responseType:null==s?void 0:s.responseType,onUploadProgress:null==s?void 0:s.onUploadProgress,onDownloadProgress:null==s?void 0:s.onDownloadProgress,validateStatus:null==s?void 0:s.validateStatus,cancelToken:null==s?void 0:s.cancelToken};return"PUT"!=e&&"POST"!=e||(c.data=r),"GET"!=e&&"DELETE"!=e||(c.params=r),t.request(c)},e.prototype.checkParam=function(e){return!(!e||e.match(/\s/g)||!e.match(/^(ht)tp(s?)\:\/\/[0-9a-zA-Z]([-.\w]*[0-9a-zA-Z])*(:(0-9)*)*(\/?)([a-zA-Z0-9\-\.\?\,\'\/\\\+&amp;%\$#_]*)?/))},e}(),n=function(){function t(t){this.instance=t||e.instance()}return t.prototype.getPlatform=function(){return"JS-SDK"},t.prototype.getPlatformVersion=function(){return""},t.prototype.getPackageName=function(){return""},t.prototype.getAppVersion=function(){return this.instance.getAppVersion()},t.prototype.getLanguage=function(){var e;return(e=navigator.languages&&navigator.languages[0]?navigator.languages[0]:navigator.language).toLowerCase().length>2?e.toLowerCase().substr(0,2):""},t.prototype.getScript=function(){return""},t.prototype.getCountry=function(){return""},t}(),s=function(){function e(){this.logger=o.createLogger("AGCWebSocketService"),this.WebSocketImpl="MozWebSocket"in window?MozWebSocket:WebSocket,this.WebSocketImpl||this.logger.error("Sorry, your browser does not support WebSockets.")}return e.prototype.connect=function(e,t,o){return this.websocket&&3!=this.websocket.readyState&&(this.websocket.close(),this.websocket=null),this.websocket=new this.WebSocketImpl(e,o),this.websocket?Promise.resolve():(this.logger.error("webSocket create fail"),Promise.reject("webSocket create fail"))},e.prototype.getReadyState=function(){return this.websocket?Number(this.websocket.readyState):null},e.prototype.send=function(e,t,o){try{if(this.websocket){if(this.websocket.send(e),t)return t()}else if(o)return o()}catch(e){if(this.logger.error(e),o)return o()}},e.prototype.close=function(e,t,o,r){try{if(this.websocket){if(this.websocket.close(e,t),o)return o()}else if(r)return r()}catch(e){if(this.logger.error(e),r)return r()}},e.prototype.onOpen=function(e){this.websocket?this.websocket.onopen=e:this.logger.error("webSocket connect failed")},e.prototype.onMessage=function(e){this.websocket?this.websocket.onmessage=function(t){e&&e(t.data)}:this.logger.error("webSocket connect failed")},e.prototype.onClose=function(e){this.websocket?this.websocket.onclose=function(t){e&&e(t.code,t.reason,t.wasClean)}:this.logger.error("webSocket connect failed")},e.prototype.onError=function(e){this.websocket?this.websocket.onerror=function(t){e&&e(t)}:this.logger.error("webSocket connect failed")},e}();function c(e){return new Promise((function(t,o){var r,n=e.method&&e.method.toUpperCase()||"GET",s={method:n,header:e.headers,url:e.url,success:function(r){var n={data:r.data,status:r.statusCode,statusText:r.errMsg,headers:r.header,config:e};e.validateStatus&&e.validateStatus(r.statusCode)||!e.validateStatus&&200==r.statusCode?t(n):o({message:r.errMsg,code:r.statusCode,response:n})},fail:function(e){o({message:e.errMsg,response:{}})},complete:function(){r=void 0}};0!==e.timeout&&(s.timeout=e.timeout),e.responseType&&(s.responseType=e.responseType),e.cancelToken&&e.cancelToken.promise.then((function(e){r&&(r.abort&&r.abort(),o(e),r=void 0)})),"PUT"==n||"POST"==n?s.data=e.data:"GET"!=n&&"DELETE"!=n||(s.data=e.params),r=wx.request(s)}))}var i=function(){function e(){this.logger=o.createLogger("AGCWebSocketService")}return e.prototype.connect=function(e,t,o){return this.websocket&&3!=this.websocket.readyState&&(this.websocket.close(),this.websocket=null),this.websocket=wx.connectSocket({url:e,header:t,protocols:o}),this.websocket?Promise.resolve():(this.logger.error("webSocket create fail"),Promise.reject("webSocket create fail"))},e.prototype.getReadyState=function(){return this.websocket?Number(this.websocket.readyState):null},e.prototype.send=function(e,t,o){this.websocket?this.websocket.send({data:e,success:t,fail:o}):o&&o()},e.prototype.close=function(e,t,o,r){this.websocket?this.websocket.close({code:e,reason:t,success:o,fail:r}):r&&r()},e.prototype.onOpen=function(e){this.websocket?this.websocket.onOpen(e):this.logger.error("webSocket connect failed")},e.prototype.onMessage=function(e){this.websocket?this.websocket.onMessage((function(t){e&&e(t.data)})):this.logger.error("webSocket connect failed")},e.prototype.onClose=function(e){this.websocket?this.websocket.onClose((function(t){e&&e(t.code,t.reason,t.wasClean)})):this.logger.error("webSocket connect failed")},e.prototype.onError=function(e){this.websocket?this.websocket.onError(e):this.logger.error("webSocket connect failed")},e}(),a=function(){function e(){this.logger=o.createLogger("AGCPlatformInfoService")}return e.prototype.getPlatform=function(){return"JS-SDK-Mini-Program"},e.prototype.getPlatformVersion=function(){return""},e.prototype.getPackageName=function(){return""},e.prototype.getAppVersion=function(){try{return wx.getAccountInfoSync().miniProgram.version}catch(e){return this.logger.error("getAppVersion:fail,",e),""}},e.prototype.getLanguage=function(){try{return wx.getSystemInfoSync().language}catch(e){return this.logger.error("getLanguage:fail,",e),""}},e.prototype.getScript=function(){return""},e.prototype.getCountry=function(){return""},e}(),u="undefined"==typeof window&&"object"==typeof wx;var p=e;p.registerInternalService({name:"AGCNetworkService",serviceFactory:function(e){return u?new r(c):new r}}),p.registerInternalService({name:"AGCWebSocketService",serviceFactory:function(e){return u?new i:new s}}),p.registerInternalService({name:"AGCPlatformInfoService",serviceFactory:function(e){return u?new a:new n(e)}});
